generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum UserRole {
  LEASER
  OWNER
  ADMIN
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
}

enum EscrowStatus {
  HOLDING
  RELEASED
  REFUNDED
}

enum LandStatus {
  UNVERIFIED
  AVAILABLE
  IN_NEGOTIATION
  LEASED
  HIDDEN
  REJECTED

}

// --- MODELS ---

model User {
  // Primary Key is the Clerk ID string
  id             String        @id @map("_id") 
  
  // Minimal mirror fields for searching/sorting in your own DB
  // Treat these as "Read-Only" - updated only via Webhooks
  
  name           String?
  
  // Business logic Clerk doesn't know about
  role           UserRole      @default(LEASER)
  isKycVerified  Boolean       @default(false)
  
  // Relations
  kycDetails     KycDetail?
  lands          Land[]        @relation("OwnerLands")
  applications   Application[] @relation("LeaserApplications")
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model KycDetail {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  citizenshipNumber String
  documentUrl       String   // S3/Cloudinary link
  selfieUrl         String?
  status            String   @default("PENDING") 
}

model Land {
  id             String     @id @default(auto()) @map("_id") @db.ObjectId
  ownerId        String     // Clerk IDs are Strings, this is correct
  owner          User       @relation("OwnerLands", fields: [ownerId], references: [id])
  
  title          String
  description    String
  location       String     // Consider adding an index if you search by location often
  
  sizeInSqmeter  Float      // Good for precision
  pricePerMonth  Float      // Good, just be careful with rounding in Frontend
  
  heroImageUrl   String
  galleryUrls    String[]   // Correct for MongoDB arrays
  lalpurjaUrl    String?    // Correct: Optional as some might upload later
  
  status         LandStatus @default(AVAILABLE)
  
  applications   Application[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([location]) // Optimization for your .search query
}
model Application {
  id                     String            @id @default(auto()) @map("_id") @db.ObjectId
  landId                 String            @db.ObjectId
  land                   Land              @relation(fields: [landId], references: [id])
  
  leaserId               String            
  leaser                 User              @relation("LeaserApplications", fields: [leaserId], references: [id])
  
  plans                  String            
  leaseDurationInMonths  Int               
  proposedMonthlyRent    Float             
  status                 ApplicationStatus @default(PENDING)
  
  escrow                 Escrow?
  agreement              LeaseAgreement?
  chatChannelId          String?           
  
  createdAt              DateTime          @default(now())
  additionalMessages     String?           
}

model Escrow {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  applicationId  String       @unique @db.ObjectId
  application    Application  @relation(fields: [applicationId], references: [id])
  
  amount         Float
  paymentId      String?      // Reference from Khalti/eSewa
  status         EscrowStatus @default(HOLDING)
  commission     Float        
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model LeaseAgreement {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  applicationId   String      @unique @db.ObjectId
  application     Application @relation(fields: [applicationId], references: [id])
  
  malpotPaperUrl  String      // Scanned agreement
  adminVerified   Boolean     @default(false)
  verifiedAt      DateTime?
  
  createdAt       DateTime    @default(now())
}